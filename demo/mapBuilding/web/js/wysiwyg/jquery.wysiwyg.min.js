/**
 * WYSIWYG - jQuery plugin @VERSION
 * (Pretty girl)
 *
 * Copyright (c) 2008-2009 Juan M Martinez, 2010-2011 Akzhan Abdulin and all contributors
 * https://github.com/akzhan/jwysiwyg
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */

/*jslint browser: true, forin: true */
(function(e){function n(e){var t;if("string"!==typeof e)return false;t=e.split(".");if(2>t.length)return false;return{name:t[0],method:t[1]}}function r(n,r){function w(){var e=3,t=function(e){if("on"===o.designMode){if(v.designMode)window.clearTimeout(v.designMode);if(A()!==o)L();return}try{o.designMode="on"}catch(n){}e-=1;if(e>0)v.designMode=window.setTimeout(function(){t(e)},100)};t(e)}function E(){s.get(0).contentWindow.focus();return i}function S(){var e=getInteralSelection();if(!e)return null;if(e.rangeCount&&e.rangeCount>0)return e.getRangeAt(0);else if(e.createRange)return e.createRange();return null}function x(){var e=C();if(!e)return null;if(e.rangeCount&&e.rangeCount>0)e.getRangeAt(0);else if(e.createRange)return e.createRange();return null}function T(){var e=S();if(e.toString)e=e.toString();else if(e.text)e=e.text;return e}function N(){if(s.get(0).contentWindow){if(s.get(0).contentWindow.getSelection)return s.get(0).contentWindow.getSelection();if(s.get(0).contentWindow.selection)return s.get(0).contentWindow.selection}if(o.getSelection)return o.getSelection();if(o.selection)return o.selection;return null}function C(){return window.getSelection?window.getSelection():window.document.selection}function k(){var t=p.width||p.clientWidth||0,n=p.height||p.clientHeight||0,r;f=p.closest("form");if(e.browser.msie&&parseInt(e.browser.version,10)<8)h.autoGrow=false;if(t===0&&p.cols)t=p.cols*8+21;if(n===0&&p.rows)n=p.rows*16+16;s=e(window.location.protocol==="https:"?'<iframe src="javascript:false;"></iframe>':"<iframe></iframe>").attr("frameborder","0");u=e("<div/>").addClass("wysiwyg");if(h.iFrameClass)s.addClass(h.iFrameClass);else{s.css({minHeight:(n-6).toString()+"px",width:t>50?(t-8).toString()+"px":""});if(e.browser.msie&&parseInt(e.browser.version,10)<7)s.css("height",n.toString()+"px")}s.attr("tabindex",p.attr("tabindex"));if(!h.iFrameClass){u.css({width:t>0?t.toString()+"px":"100%"})}p.hide().before(u);y=false;initialContent=p.val();if(h.resizeOptions&&e.fn.resizable){u.resizable(e.extend(true,{alsoResize:this.editor},h.resizeOptions))}if(h.autoSave)f.bind("submit.wysiwyg",function(){i.save()});f.bind("reset.wysiwyg",function(){i.clear()});L();return i}function L(){var n,r,a,f;if(h.toolbar){m.toolbar=e(h.toolbar).addClass("toolbar")}else{m.toolbar=e(h.toolbarHtml).appendTo(u)}m.toolbar.attr("user-select","none").attr("unselectable","on").attr("role","menu");u.append(e("<div><!-- --></div>").css({clear:"both"})).append(s);o=A();if(e.type(h.controls)=="string"){f=[];e.each(h.controls.split(","),function(n,r){if(r=="|"){m.addSeparator();return true}else f.push(r);if(!e.wysiwyg.controls[r]){t.error("Control: '"+r+"' was not found.");return true}m.addControl(r,e.wysiwyg.controls[r]);return true});h.controls={};e.each(f,function(t,n){h.controls[n]=e.wysiwyg.controls[n]})}w();o.open();o.write(h.html.replace(/INITIAL_CONTENT/,e.wysiwyg.utils.wrapTextContent(h.initialContent)));o.close();e(o).trigger("initFrame.wysiwyg").bind("click.wysiwyg",function(e){m.refresh(e.target?e.target:e.srcElement)}).keydown(function(e){var t;if(e.keyCode===0){t=/^<([\w]+)[^>]*>(<br\/?>)?<\/\1>$/;if(t.test(i.getContent())){e.stopPropagation();return false}}return true}).keydown(function(t){var n,r;if(!e.browser.msie){if(t.ctrlKey||t.metaKey){for(n in h.controls){if(h.controls[n].hotkey&&h.controls[n].hotkey.ctrl){if(t.keyCode===h.controls[n].hotkey.key){M(n,h.controls[n]);return false}}}}return true}else if(h.brIE&&t.keyCode===13){r=x();r.pasteHTML("<br />");r.collapse(false);r.select();return false}else return true});if(h.maxLength>0){e(o).keydown(function(t){if(e(o).text().length>=h.maxLength&&e.inArray(t.which,g)==-1)t.preventDefault()})}if(h.autoSave){e(o).bind("keydown keyup mousedown",function(e){i.save()}).bind(e.support.noCloneEvent?"input.wysiwyg":"paste.wysiwyg",function(e){i.save()})}p.focus(function(){if(e(this).filter(":visible"))return;E()});if(h.css){if(e.type(h.css)=="string"){if(e.browser.msie)n=e(o.createStyleSheet(h.css)).attr({media:"all"});else{n=e("<link/>").attr({href:h.css,media:"all",rel:"stylesheet",type:"text/css"}).appendTo(e(o).find("head"))}}else s.ready(function(){e(o.body).css(h.css)})}e.each(h.events,function(t,n){e(o).bind(t+".wysiwyg",function(e){n.apply(o,[e,i])})});if(e.browser.msie){e(o).bind("beforedeactivate.wysiwyg",function(e){d=S()})}else{e(o).bind("blur.wysiwyg",function(e){d=S()})}e(o).bind("focusin.wysiwyg",function(t){e.wysiwyg.activeEditor=e(p).data("wysiwyg")});e(o.body).addClass("wysiwyg");if(h.events.save&&e.isFunction(h.events.save)){a=h.events.save;e(o).bind("keyup.wysiwyg",a).bind("change.wysiwyg",a);if(e.support.noCloneEvent)e(o).bind("input.wysiwyg",a);else{e(o).bind("paste.wysiwyg",a).bind("cut.wysiwyg",a)}}c=false}function A(){var n=e(s).get(0);if(n.nodeName.toLowerCase()==="iframe"){if(n.contentDocument)return n.contentDocument;else if(n.contentWindow)return n.contentWindow.document;t.error("Unexpected error in innerDocument")}return n}function O(){var e;if(d!==null){if(window.getSelection){e=window.getSelection();if(e.rangeCount>0)e.removeAllRanges();try{e.addRange(d)}catch(n){t.error(n)}}else if(window.document.createRange)window.getSelection().addRange(d);else if(window.document.selection)d.select();d=null}}function M(n,r){var s=r.command||n,u=r["arguments"]||r.args||[];if(r.exec)r.exec.apply(m.mode=="external"?e.wysiwyg.activeEditor:i);else{E();if(e.browser.mozilla){try{o.execCommand("styleWithCSS",false,false)}catch(a){try{o.execCommand("useCSS",false,true)}catch(f){}}}try{o.execCommand(s,false,u)}catch(a){t.error(a)}}if(h.autoSave)i.save();return true}var i=this,s=null,o=null,u=null,a={},f=null,l,c=true,h=e.extend({},e.wysiwyg.config,r),p=e(n),d=null,v=[],m={},g=[8,9,13,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,46],y,b=["onBeforeInit","onInit","onFrameInit","beforeCreate","afterCreate","beforeDestroy","afterDestroy","beforeSave","afterSave"];l=n.add(i);this.options=h;e.extend(m,{addControl:function(t,n){var r=n.className||n.command||t||"empty",i=n.tooltip||n.command||t||"",s,o;o=e(m.toolbar).data("controlNames")||[];if(e.inArray(t,o)!=-1)return true;o.push(t);e(m.toolbar).data("controlNames",o);e.wysiwyg.controls[t]=n;s=e('<li role="menuitem" unselectable="on">'+r+"</li>");if(n.icon)s.css("background-image",n.icon);s.addClass(r).attr("title",i).hover(function(t){e(this).addClass("wysiwyg-button-hover")},function(t){e(this).removeClass("wysiwyg-button-hover")}).click(function(r){var i=e(this);if(r.isDefaultPrevented()||i.attr("disabled")=="true")return false;M(t,n);i.blur();O();E();return true}).appendTo(m.toolbar);return s},addSeparator:function(){return e('<li role="separator" class="separator"></li>').appendTo(m.toolbar)},mode:h.toolbar?"external":"default",focus:function(){},refresh:function(t){e.each(h.controls,function(n,r){var s=r.className||r.command||n||"empty",o,u,a,f,l=function(t,n){var r;if(e.isFunction(n)){r=n;if(r(f.css(t).toString().toLowerCase(),i))m.toolbar.find("."+s).addClass("active")}else{if(f.css(t).toString().toLowerCase()===n)m.toolbar.find("."+s).addClass("active")}};if("fullscreen"!==s)m.toolbar.find("."+s).removeClass("active");if(r.tags||r.options&&r.options.tags){o=r.tags||r.options&&r.options.tags;u=t;while(u){if(u.nodeType!==1)break;if(e.inArray(u.tagName.toLowerCase(),o)!==-1)m.toolbar.find("."+s).addClass("active");u=u.parentNode}}if(r.css||r.options&&r.options.css){a=r.css||r.options&&r.options.css;f=e(t);while(f){if(f[0].nodeType!==1)break;e.each(a,l);f=f.parent()}}})}});e.extend(i,{clear:function(){},console:function(){},destroy:function(){c=true;return i},getContent:function(){return o.body.innerHTML},getConfig:function(){return h},getSelection:function(){return T()},getTextarea:function(){return p},init:function(){if(!c)return i;l.trigger("onBeforeInit",[i]);k();l.trigger("onInit",[i]);return i},insertHTML:function(){},removeFormat:function(){},refresh:function(){},save:function(){var t,n;t=e.Event("beforeSave");n=l.trigger(t,[i]);if(t.isDefaultPrevented()||!n)return i;p.val(i.getContent());l.trigger("afterSave",[i]);return i},selectAll:function(){},setContent:function(){},triggerControl:function(n){if(!e.wysiwyg.controls[n]){t.error("Control: '"+n+"' was not found.");return false}return M(n,e.wysiwyg.controls[n])},ui:m});e.each(h.plugins,function(e,t){});e.each(b,function(t,n){if(e.isFunction(h[n]))e(i).bind(n,h[n]);i[n]=function(t){if(t){e(i).bind(n,t)}return i}});if(h.init)return i.init();return i}var t=window.console?window.console:{log:e.noop,error:function(t){e.error(t)}};e.wysiwyg=e.wysiwyg||{version:"@VERSION"};e.wysiwyg.config={html:'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body style="margin: 0px;">INITIAL_CONTENT</body></html>',debug:false,controls:"bold,italic,undo,redo",init:true,css:{},events:{},autoGrow:false,autoSave:true,brIE:true,formHeight:270,formWidth:440,iFrameClass:null,initialContent:"",maxHeight:1e4,maxLength:0,toolbar:false,toolbarHtml:'<ul unselectable="on" role="menu" class="toolbar"></ul>',removeHeadings:false,replaceDivWithP:false,resizeOptions:false,rmUnusedControls:false,rmUnwantedBr:true,tableFiller:"Lorem ipsum",initialMinHeight:null,plugins:{},dialog:"default"};e.wysiwyg.activeEditor=null;e.wysiwyg.controls={register:function(){}};e.wysiwyg.utils={extraSafeEntities:[["<",">","'",'"'," "],[32]],encodeEntities:function(t){var n=this,r,i=[];if(this.extraSafeEntities[1].length===0){e.each(this.extraSafeEntities[0],function(e,t){n.extraSafeEntities[1].push(t.charCodeAt())})}r=t.split("");e.each(r,function(t){var s=r[t].charCodeAt();if(e.inArray(s,n.extraSafeEntities[1])&&(s<65||s>127||s>90&&s<97)){i.push("&#"+s+";")}else{i.push(r[t])}});return i.join("")},wrapTextContent:function(e){var t=e.match(/<\/?p>/gi);if(!t)return"<p>"+e+"</p>";else{}return e}};e.wysiwyg.plugin={register:function(n){if(!n.name)t.error("Plugin name missing");if(!e.wysiwyg[n.name])e.wysiwyg[n.name]=n;return true},exists:function(t){var r;if("string"!==typeof t)return false;r=n(t);return e.wysiwyg[r.name]||e.wysiwyg[r.name][r.method]}};e.wysiwyg.dialog=function(t,n){var r=t.options.dialog,i=e.wysiwyg.dialog.createDialog(t.options.dialog),s=this,o=e(s);this.options={title:"Title",content:"Content"};this.isOpen=false;e.extend(this.options,n);this.open=function(){this.isOpen=true;i.init.apply(s,[]);var e=i.show.apply(s,[]);o.trigger("afterOpen",[e])};this.show=function(){this.isOpen=true;o.trigger("beforeShow");var e=i.show.apply(s,[]);o.trigger("afterShow")};this.hide=function(){this.isOpen=false;o.trigger("beforeHide");var e=i.hide.apply(s,[]);o.trigger("afterHide",[e])};this.close=function(){this.isOpen=false;var e=i.hide.apply(s,[]);o.trigger("beforeClose",[e]);i.destroy.apply(s,[]);o.trigger("afterClose",[e])};return this};e.extend(true,e.wysiwyg.dialog,{_themes:{},_theme:"",register:function(t,n){e.wysiwyg.dialog._themes[t]=n},deregister:function(t){delete e.wysiwyg.dialog._themes[t]},createDialog:function(t){return new e.wysiwyg.dialog._themes[t]}});e.fn.wysiwyg=function(t){var n=this.data("wysiwyg"),i;if(n)return n;config=e.extend({},e.wysiwyg.config,t);this.each(function(){i=new r(e(this),config);e(this).data("wysiwyg",i)});return this}})(jQuery)